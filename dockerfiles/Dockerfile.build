ARG CCACHE_DIR="/ccache"
ARG CCACHE_LOC="/source"
ARG COMMAND="${CCACHE_LOC}/ci/build"
ARG INTERACTIVE
ARG ASAN_OPTIONS
ARG EXTRA_CMAKE_BUILD_FLAGS
ARG CC
ARG CFLAGS
ARG CMAKE_PARAMS
ARG CXX
ARG CXXFLAGS
ARG LDFLAGS
ARG NO_TEST
ARG SCAN_BUILD
ARG SPECIAL
ARG VERBOSE

ARG INSTALL_PREFIX

ENV TROOT="/tmp/build_cache_root"
ENV CCACHE_BIN="${INSTALL_PREFIX}/bin/ccache"
ENV CCACHE_ROOT="/root"
ENV CCACHE_DIR="${CCACHE_ROOT}/.ccache"

RUN mkdir -p ${CCACHE_DIR}
RUN --mount=type=bind,from=buildcache,source=/,target=${TROOT} \
 test ! -d ${TROOT}${CCACHE_DIR} || \
  cp -a ${TROOT}${CCACHE_DIR} ${CCACHE_ROOT}/
RUN --mount=type=bind,from=buildcache,source=/,target=${TROOT} \
 test ! -e ${TROOT}${CCACHE_BIN} || \
  cp ${TROOT}${CCACHE_BIN} ${CCACHE_BIN}
RUN test ! -e ${CCACHE_BIN} || ${CCACHE_BIN} --max-size=10M
RUN test ! -e ${CCACHE_BIN} || ${CCACHE_BIN} --set-config=hash_dir=false
RUN test ! -e ${CCACHE_BIN} || ${CCACHE_BIN} --zero-stats
RUN test ! -e "${CCACHE_DIR}/debug" || rm -r "${CCACHE_DIR}/debug"

WORKDIR ${CCACHE_LOC}

COPY --exclude=.git* --exclude=dockerfiles . ${CCACHE_LOC}
ARG BASE_IMAGE
ARG TARGETPLATFORM
ENV CCACHE_STATSLOG="/tmp/ccstats.log"
##ENV CCACHE_DEBUG="true"
##ENV CCACHE_DEBUGDIR="${CCACHE_DIR}/debug"
##ENV CCACHE_DEBUGLEVEL="2"
RUN CMAKE_PARAMS="-DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} \
  `./misc/get-arch-buildargs platformopts ${CMAKE_PARAMS}`"; test "${?}" -ne 0 && exit 1; \
  CMAKE_PARAMS="${CMAKE_PARAMS}" ${COMMAND}
RUN make -C build install
ENV L_STATS="${CCACHE_DIR}/lastbuild.stats"
ENV V_STATS="${CCACHE_DIR}/lastbuild.log.v.stats"
RUN ${CCACHE_BIN} --show-stats > ${L_STATS}
RUN ${CCACHE_BIN} --show-log-stats -v > ${V_STATS}
RUN cat ${L_STATS} ${V_STATS}
RUN test ! -e ${CCACHE_STATSLOG} || \
 awk '/^cache_miss$/ { print substr(previous, 3) } { previous = $0 }' "${CCACHE_STATSLOG}"
FROM scratch AS export
ARG INSTALL_PREFIX
ENV CCACHE_BIN="${INSTALL_PREFIX}/bin/ccache"
ENV CCACHE_DIR="/root/.ccache"
COPY --from=build ${CCACHE_BIN} ${CCACHE_BIN}
COPY --from=build ${CCACHE_DIR} ${CCACHE_DIR}
